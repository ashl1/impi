#summary Формат файлов qhf с историей клиента QIP Infium

= Формат файлов qhf с историей клиента QIP Infium =

Исследовался формат программы QIP Infium (Build 9042).

Конфигурационная директория для QIP Infium на Windows 7 располагается в `%ApplicationData%\QIP\Profiles\`. В этой директории находятся директории клиентских аккаунтов, но история в каждом аккаунте располагается в директории History.

История хранится в файлах с расширением qhf (qip history file). В имени файла присутствует идентификационный номер собеседника и протокол. Формат файла приведён в таблице.

При этом в данной директории `History` также есть директория `Archive` с архивными файлами qha (qip history arvhive). Их формат совпадает с форматом qhf.

<table border="1px" cellspacing="0">
<tr><td>Байты</td><td>0x00</td><td>Символ</td><td>Описание</td></tr>
<tr><td>1</td><td>51</td><td>Q</td><td rowspan="3">Заголовок. Тип файла</td></tr>
<tr><td>2</td><td>48</td><td>H</td></tr>
<tr><td>3</td><td>46</td><td>F</td></tr>
<tr><td>4</td><td>3</td><td> </td><td>Версия файла с историей</td></tr>
<tr><td>5</td><td>0</td><td> </td><td rowspan="4">Размер тела (все следующие данные), без учёта заголовка (байты 01-8)</td></tr>
<tr><td>6</td><td>0</td><td> </td></tr>
<tr><td>7</td><td>0</td><td> </td></tr>
<tr><td>8</td><td>D0</td><td> </td></tr>
<tr><td>9</td><td>0</td><td> </td><td rowspan="10">10 байт. Резерв?</td></tr>
<tr><td>10</td><td>0</td><td> </td></tr>
<tr><td>11</td><td>0</td><td> </td></tr>
<tr><td>12</td><td>0</td><td> </td></tr>
<tr><td>13</td><td>0</td><td> </td></tr>
<tr><td>14</td><td>0</td><td> </td></tr>
<tr><td>15</td><td>0</td><td> </td></tr>
<tr><td>16</td><td>0</td><td> </td></tr>
<tr><td>17</td><td>0</td><td> </td></tr>
<tr><td>18</td><td>0</td><td> </td></tr>
<tr><td>19</td><td> </td><td> </td><td rowspan="16">16 байт. Неизвестно</td></tr>
<tr><td>20</td><td> </td><td> </td></tr>
<tr><td>21</td><td> </td><td> </td></tr>
<tr><td>22</td><td> </td><td> </td></tr>
<tr><td>23</td><td> </td><td> </td></tr>
<tr><td>24</td><td> </td><td> </td></tr>
<tr><td>25</td><td> </td><td> </td></tr>
<tr><td>26</td><td> </td><td> </td></tr>
<tr><td>27</td><td> </td><td> </td></tr>
<tr><td>28</td><td> </td><td> </td></tr>
<tr><td>29</td><td> </td><td> </td></tr>
<tr><td>30</td><td> </td><td> </td></tr>
<tr><td>31</td><td> </td><td> </td></tr>
<tr><td>32</td><td> </td><td> </td></tr>
<tr><td>33</td><td> </td><td> </td></tr>
<tr><td>34</td><td> </td><td> </td></tr>
<tr><td>35</td><td>0</td><td> </td><td rowspan="4">Общее количество сообщений в чате (и пользователя, и собеседника)</td></tr>
<tr><td>36</td><td>0</td><td> </td></tr>
<tr><td>37</td><td>0</td><td> </td></tr>
<tr><td>38</td><td>1</td><td> </td></tr>
<tr><td>39</td><td>0</td><td> </td><td rowspan="4">Повтор предыдущих 4-х байт?</td></tr>
<tr><td>40</td><td>0</td><td> </td></tr>
<tr><td>41</td><td>0</td><td> </td></tr>
<tr><td>42</td><td>1</td><td> </td></tr>
<tr><td>43</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>44</td><td>0</td><td> </td></tr>
<tr><td>45</td><td>0</td><td> </td><td rowspan="2">Размер следующей строки</td></tr>
<tr><td>46</td><td>9</td><td> </td></tr>
<tr><td>47</td><td> </td><td> </td><td>Строчка. UIN (ICQ), QIP Name (QIP):463018421 или kotjar4ik@qip.ru</td></tr>
<tr><td>48</td><td>0</td><td> </td><td>Терминальный символ строки</td></tr>
<tr><td>49</td><td>9</td><td> </td><td>Размер следующей строки</td></tr>
<tr><td>50</td><td> </td><td> </td><td>Строчка. Псевдоним (ICQ), QIP Name (QIP):Kadark или kotjar4ik@qip.ru</td></tr>
<tr><td>51</td><td>0</td><td> </td><td> </td></tr>
<tr><td>52</td><td>1</td><td> </td><td>Тип следующего аттрибута? Размер?</td></tr>
<tr><td>53</td><td>0</td><td> </td><td rowspan="4">Смещение до следующего сообщения</td></tr>
<tr><td>54</td><td>0</td><td> </td></tr>
<tr><td>55</td><td>0</td><td> </td></tr>
<tr><td>56</td><td>21</td><td> </td></tr>
<tr><td>57</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>58</td><td>1</td><td> </td></tr>
<tr><td>59</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>60</td><td>4</td><td> </td></tr>
<tr><td>61</td><td>0</td><td> </td><td rowspan="4">Номер сообщения в чате</td></tr>
<tr><td>62</td><td>0</td><td> </td></tr>
<tr><td>63</td><td>0</td><td> </td></tr>
<tr><td>64</td><td>1</td><td> </td></tr>
<tr><td>65</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>66</td><td>2</td><td> </td></tr>
<tr><td>67</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>68</td><td>4</td><td> </td></tr>
<tr><td>69</td><td>4d</td><td> </td><td rowspan="4">Время – unix timestamp</td></tr>
<tr><td>70</td><td>5b</td><td> </td></tr>
<tr><td>71</td><td>de</td><td> </td></tr>
<tr><td>72</td><td>dc</td><td> </td></tr>
<tr><td>73</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>74</td><td>3</td><td> </td></tr>
<tr><td>75</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>76</td><td>3</td><td> </td></tr>
<tr class="ro3"><td>77</td><td>1</td><td> </td><td>Boolean.01 — сообщение отправлено,00 – если получено</td></tr>
<tr><td>78</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>79</td><td>1</td><td> </td></tr>
<tr><td>80</td><td>0</td><td> </td><td rowspan="2">-</td></tr>
<tr><td>81</td><td>4</td><td> </td></tr>
<tr><td>82</td><td>0</td><td> </td><td rowspan="4">Размер следующей строки (сообщения)</td></tr>
<tr><td>83</td><td>0</td><td> </td></tr>
<tr><td>84</td><td>0</td><td> </td></tr>
<tr><td>85</td><td>4</td><td> </td></tr>
<tr><td>86</td><td> </td><td> </td><td>Текст сообщения.</td></tr>
</table>

Текст сообщения представляет собой зашифрованную UTF-строку. Шифрование заключается в следующем:
 # Каждый символ текста представим в виде байт.
 # Для каждого байта (если символ UTF, то байта 2, но это не важно) производим операцию
{{{
новое значение = 0xFE - старое значение	 
}}}
 # Заводится счётчик, изначально равный 0. За каждый цикл он увеличивается на 1.
 # Цикл: для каждого байта производится операция
{{{
результат = новое значение - счётчик
}}}

*Примечание*

Стоит также отметить, что все вычисления производятся с одним байтом. Соответственно при вычитании счётчика, большее значения, значение переполняетя.  То есть 0x01 - 0x02 = 0xFF.