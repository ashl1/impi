#summary Форматы хранения истории клиентов Skype

= Skype Linux =

Исследовался формат программы Skype Linux (build 2.1.0.81).

Конфигурационная директория для Skype на Linux располагается в <font face="monospace">$HOME/.Skype/</font>. В этой директории находятся директории клиентских аккаунтов, но в ней могут быть файлы и папки приложения, не связанные с историей файлов (<font face="monospace">shared_dynco/, shared_httpfe/, shared.lck и shared.xml</font>).

Skype в Linux хранит всю базу в собственном формате, поэтому пришлось разбирать её вручную. Структура БД Skype Linux, по видимому, очень похожа на структуру БД Skype Windows, которая описана ниже.

*Skype-блок* — это блок определённого максимального размера, который начинается с заголовка <font face="monospace">0x6C 0x33 0x33 0x6C</font>
(ANSI: l33l). Размер заголовка включается в общий размер блока.

Таблица в базе данных Skype распределена на несколько файлов по определённому размеру Skype блоков — по степени двойки, начиная со 28. В конце имен файлов (имеют расширение `.dbb`) присутствует указание на максимальный размер skype-блоков, записанных в файле, например, <font face="monospace">chatmsg256.dbb, chatmsg512.dbb, chatmsg8192.dbb</font>. Таким образом, чтобы собрать информацию, даже за определённый промежуток времени, нужно просканировать все файлы распределённой таблицы.

Рассмотрим интересующую нас таблицу chatmsg. Таблицы chat и chatmember рассматривать не будем, поскольку в полях таблицы chatmsg уже содежится указание на участников чата, но, возможно, это придётся сделать в дальнейшем. Также не была рассмотрена важная таблица user, в которой хранятся анкеты пользователей. Сейчас в качестве имени пользователя используется его логин.

<table border="1" cellspacing="0">
<tr><td>№</td><td>0x00</td><td>Описание</td></tr>
<tr><td>0</td><td>0x6c</td><td rowspan="4">Заголовок сообщения. Не изменяется</td></tr>
<tr><td>1</td><td>0x33</td></tr>
<tr><td>2</td><td>0x33</td></tr>
<tr><td>3</td><td>0x6c</td></tr>
<tr><td>4</td><td>0xba</td><td rowspan="4">Счётчик 1. Считает только определённого типа. То есть значение для каждого определённого типа своё</td></tr>
<tr><td>5</td><td>0x00</td></tr>
<tr><td>6</td><td>0x00</td></tr>
<tr><td>7</td><td>0x00</td></tr>
<tr><td>8</td><td>0x31</td><td rowspan="4">Счётчик 2. Общее кол-во сообщений? Номер сообщения в последовательности чата, сформированной по всем .dbb</td></tr>
<tr><td>9</td><td>0x00</td></tr>
<tr><td>10</td><td>0x00</td></tr>
<tr><td>11</td><td>0x00</td></tr>
<tr><td>12</td><td>0x41</td><td>Не изменяется</td></tr>
<tr><td>13</td><td>0x0d</td><td>Тип сообщения?0A — когда тебя(ты?) добавили в чат,0d — обычное сообщение,01 – пустышка(есть только 1-е 16 байт skype-блока)</td></tr>
<tr><td>14</td><td>0x00</td><td rowspan="4">Не изменяется</td></tr>
<tr><td>15</td><td>0x09</td></tr>
<tr><td>16</td><td>0x09</td></tr>
<tr><td>17</td><td>0x03</td></tr>
<tr><td>18</td><td>0xe0</td><td rowspan="2">Региональные настройки Skype клиента?</td></tr>
<tr><td>19</td><td>0x03</td></tr>
<tr><td>20</td><td> </td><td>Идентификатор чата вида #nasteaaaa/$ashl1future;ffd153be7aead041 </td></tr>
<tr><td>21</td><td>0x00</td><td rowspan="4">Не изменяется</td></tr>
<tr><td>22</td><td>0x00</td></tr>
<tr><td>23</td><td>0xe5</td></tr>
<tr><td>24</td><td>0x03</td></tr>
<tr><td>25</td><td>0xce</td><td rowspan="4">Дата/время</td></tr>
<tr><td>26</td><td>0x86</td></tr>
<tr><td>27</td><td>0xb4</td></tr>
<tr><td>28</td><td>0xe1</td></tr>
<tr><td>29</td><td>0x04</td><td rowspan="4">Не изменяется</td></tr>
<tr><td>30</td><td>0x03</td></tr>
<tr><td>31</td><td>0xe8</td></tr>
<tr><td>32</td><td>0x03</td></tr>
<tr><td>33</td><td> </td><td>Ashl1future — логин отправившего</td></tr>
<tr><td>34</td><td>0x00</td><td>Терминальный символ</td></tr>
<tr><td>35</td><td>0x00</td><td rowspan="6">Не изменяется</td></tr>
<tr><td>36</td><td>0x81</td></tr>
<tr><td>37</td><td>0x04</td></tr>
<tr><td>38</td><td>0x02</td></tr>
<tr><td>39</td><td>0x00</td></tr>
<tr><td>40</td><td>0x0b</td></tr>
<tr><td>41</td><td>dc</td><td rowspan="5">Счётчик 3</td></tr>
<tr><td>42</td><td>ea</td></tr>
<tr><td>43</td><td>ca</td></tr>
<tr><td>44</td><td>c7</td></tr>
<tr><td>45</td><td>1</td></tr>
<tr><td>46</td><td>0</td><td rowspan="2">Не изменяется</td></tr>
<tr><td>47</td><td>7</td></tr>
<tr><td>48</td><td>c8</td><td rowspan="5">Неизвестно</td></tr>
<tr><td>49</td><td>d0</td></tr>
<tr><td>50</td><td>8b</td></tr>
<tr><td>51</td><td>fc</td></tr>
<tr><td>52</td><td>5</td></tr>
<tr><td>53</td><td>0x03</td><td rowspan="3">Не изменяется</td></tr>
<tr><td>54</td><td>0xfc</td></tr>
<tr><td>55</td><td>0x03</td></tr>
<tr><td>56</td><td> </td><td>Текст сообщения в UTF8</td></tr>
<tr><td>57</td><td>0x00</td><td>Терминальный символ</td></tr>
<tr><td>58</td><td>0xf1</td><td rowspan="5">Не изменяется</td></tr>
<tr><td>59</td><td>0x03</td></tr>
<tr><td>60</td><td>0x03</td></tr>
<tr><td>61</td><td>0x00</td></tr>
<tr><td>62</td><td>0x03</td></tr>
<tr><td>63</td><td> </td><td rowspan="4">Счётчик 4</td></tr>
<tr><td>64</td><td> </td></tr>
<tr><td>65</td><td> </td></tr>
<tr><td>66</td><td> </td></tr>
<tr><td>67</td><td>0x03</td><td rowspan="3">Не изменяется</td></tr>
<tr><td>68</td><td>0xec</td></tr>
<tr><td>69</td><td>0x03</td></tr>
<tr><td>70</td><td> </td><td>Отображаемое имя отправившего в текущее время в клиента: Alexey Shildyakov</td></tr>
<tr><td>71</td><td>0x00</td><td>Терминальный символ</td></tr>
<tr><td>72</td><td>0x03</td><td rowspan="3">Не изменяется</td></tr>
<tr><td>73</td><td>0xf4</td></tr>
<tr><td>74</td><td>0x03</td></tr>
<tr><td>75</td><td> </td><td>Список участников чата: ashl1future nasteaaaa</td></tr>
</table>

Поиск нужной информации в Skype-блоке производится по ключевым сочетаниям байт, которые не изменяются в сообщениях. Также возможны некоторые изменения в различных skype-блоках одинакового типа, например, различный размер счётчиков 4 и 5 или отсутствие некоторых полей. Рассмотренный skype-блок может существенно отличаться от skype-блоков других типов: передача данных о качестве связи, синхронизации и прочих. При этом структура skype-блока в другой таблице будет совершенно иная.

Было замечено, что значение счётчика 1 часто совпадает со значением счётчика 2. Можно предположить, что они используются для реализации структуры собственной базы данных.

Дата и время в Skype записываются в собственном формате (описан Dmytry Lavrov [http://dmytry.com/texts/skype_chatlogs_friday_13.html Skype chatlogs]). Каждый из четырёх байтов имеет старший бит, равный единице, но каждый байт воспринимается без него. Возможно, каждый байт имеет знаковый тип и положительное значение определяется на нём с единичным старшим битом. Таким образом получается число, представляющее собой количество секунд примерно от 10.01.2004 14:35:42 UTC, что, возможно, является датой создания Skype. Пример преобразования приведён ниже.

Дата и время в формате (по увеличению адреса) <font face="monospace">0x99 0x98 0xB1 0xEC</font> представляет собой в бинарном виде <font face="monospace">11101100 10110001 10011000 10011001</font>. Игнорируя старший бит, получаем <font face="monospace">1101100 0110001 0011000 0011001</font>, что является числом <font face="monospace">227298329</font>
